import{_ as i,V as u,W as r,$ as d,X as n,Z as a,a1 as t,Y as s,a0 as l,E as p}from"./framework-ad2eb432.js";const k={},v=n("p",null,"Docker 部署 RTMP 流媒体服务器，在一端使用 RTMP 协议推流，并在前端播放直播内容。",-1),m={class:"table-of-contents"},g=n("h2",{id:"_1-创建-docker-容器",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_1-创建-docker-容器","aria-hidden":"true"},"#"),s(" 1. 创建 Docker 容器")],-1),b=n("div",{class:"custom-container info"},[n("p",{class:"custom-container-title"},"编译构建"),n("p",null,"我们从 CentOS 镜像直接下载源码来编译，这是因为没有稳定维护的第三方镜像。这样自由使用任何版本的内容构建。")],-1),h=n("code",null,"Dockerfile",-1),f=l(`<p>如果没有 CentOS 镜像，可以拉取镜像：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> pull centos:7.9.2009
</code></pre></div><p>创建 Docker 容器：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run -itd<span class="token punctuation">\\</span>
    <span class="token parameter variable">--name</span> nginx-flv<span class="token punctuation">\\</span>
    <span class="token parameter variable">-p</span> <span class="token number">1935</span>:1935<span class="token punctuation">\\</span>
    <span class="token parameter variable">-p</span> <span class="token number">8089</span>:8089<span class="token punctuation">\\</span>
    centos:7.9.2009<span class="token punctuation">\\</span>
    /bin/bash
</code></pre></div><p>然后进入容器：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> nginx-flv /bin/bash
</code></pre></div><p>下面的命令都在容器内执行。</p><h2 id="_2-源码编译" tabindex="-1"><a class="header-anchor" href="#_2-源码编译" aria-hidden="true">#</a> 2. 源码编译</h2><p>更新和安装包：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code>yum update

yum <span class="token function">install</span> gcc
yum <span class="token function">install</span> pcre pcre-devel
yum <span class="token function">install</span> openssl openssl-devel
yum <span class="token function">install</span> <span class="token function">wget</span> <span class="token function">unzip</span>
</code></pre></div>`,10),_={href:"http://nginx.org/",target:"_blank",rel:"noopener noreferrer"},y=l(`<div class="language-bash" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> http://nginx.org/download/nginx-1.23.3.tar.gz
<span class="token function">wget</span> https://github.com/winshining/nginx-http-flv-module/archive/refs/heads/master.zip
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> nginx-1.23.3.tar.gz
<span class="token function">unzip</span> master.zip

<span class="token builtin class-name">cd</span> nginx-1.23.3
./configure --with-http_ssl_module --with-http_secure_link_module --add-module<span class="token operator">=</span><span class="token punctuation">..</span>/nginx-http-flv-module-master
<span class="token function">make</span>
<span class="token function">make</span> <span class="token function">install</span>
</code></pre></div><p>下面修改 <code>/usr/local/nginx/conf/nginx.conf</code>：</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">worker_processes</span>  <span class="token number">2</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">1024</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8089</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /flv</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">flv_live</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">chunked_transfer_encoding</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>

            <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Allow-Origin&#39;</span> <span class="token string">&#39;*&#39;</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Allow-Credentials&#39;</span> <span class="token string">&#39;true&#39;</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">rtmp_auto_push</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">rtmp</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">1935</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">notify_method</span> get</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">access_log</span>  /var/log/nginx/access.log</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">chunk_size</span> <span class="token number">4096</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">application</span> live</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">live</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">allow</span> publish all</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">allow</span> play all</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">drop_idle_publisher</span> <span class="token number">20s</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试、启动 Nginx：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/log/nginx
/usr/local/nginx/sbin/nginx <span class="token parameter variable">-t</span>
/usr/local/nginx/sbin/nginx s reload
</code></pre></div><h2 id="_3-直播推流" tabindex="-1"><a class="header-anchor" href="#_3-直播推流" aria-hidden="true">#</a> 3. 直播推流</h2><p>可以将下面的 <code>\${IP}</code> 替换为你的 IP 地址。推送视频 <code>test.mp4</code>：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code>ffmpeg <span class="token parameter variable">-re</span> <span class="token parameter variable">-i</span> test.mp4 <span class="token parameter variable">-c</span> copy <span class="token parameter variable">-f</span> flv <span class="token string">&quot;rtmp://<span class="token variable">\${IP}</span>:1935/live/test&quot;</span>
</code></pre></div><p>拉取直播：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code>ffplay <span class="token string">&quot;rtmp://<span class="token variable">\${IP}</span>:1935/live/test&quot;</span>
</code></pre></div><p>推送摄像头内容：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code>ffmpeg <span class="token parameter variable">-f</span> dshow <span class="token parameter variable">-i</span> <span class="token assign-left variable">video</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${Your_Camera}</span>&quot;</span>:audio<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${Your_Audio}</span>&quot;</span> <span class="token parameter variable">-vcodec</span> libx264 <span class="token parameter variable">-acodec</span> aac <span class="token parameter variable">-f</span> flv <span class="token string">&quot;rtmp://<span class="token variable">\${IP}</span>:1935/live/test&quot;</span>
</code></pre></div><p>将视频和音频设备名称填在上方命令的视频和音频位置上即可。</p><div class="custom-container tip"><p class="custom-container-title">查看摄像头</p><p>查看视频和音频设备：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code>ffmpeg <span class="token parameter variable">-list_devices</span> <span class="token boolean">true</span> <span class="token parameter variable">-f</span> dshow <span class="token parameter variable">-i</span> dummy
</code></pre></div></div><p>测试代码如下，保存为 <code>index.html</code>：</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>FLV Player<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcss.com/flv.js/1.6.2/flv.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>videoElement<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 80%</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">controls</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>controls<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flvjs<span class="token punctuation">.</span><span class="token function">isSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> videoElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;videoElement&#39;</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> flvPlayer <span class="token operator">=</span> flvjs<span class="token punctuation">.</span><span class="token function">createPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;flv&#39;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;http://\${IP}:8089/flv?app=live&amp;stream=test&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      flvPlayer<span class="token punctuation">.</span><span class="token function">attachMediaElement</span><span class="token punctuation">(</span>videoElement<span class="token punctuation">)</span>
      flvPlayer<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      flvPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16);function x(w,q){const e=p("router-link"),c=p("Badge"),o=p("ExternalLinkIcon");return u(),r("div",null,[v,d(" more "),n("nav",m,[n("ul",null,[n("li",null,[a(e,{to:"#_1-创建-docker-容器"},{default:t(()=>[s("1. 创建 Docker 容器")]),_:1})]),n("li",null,[a(e,{to:"#_2-源码编译"},{default:t(()=>[s("2. 源码编译")]),_:1})]),n("li",null,[a(e,{to:"#_3-直播推流"},{default:t(()=>[s("3. 直播推流")]),_:1})])])]),g,b,n("p",null,[a(c,{type:"danger",vertical:"middle"},{default:t(()=>[s("TODO")]),_:1}),s(" 使用 "),h,s(" 来完成构建。")]),f,n("p",null,[s("编译 Nginx 和 HTTP-FLV，"),n("a",_,[s("Nginx 官网"),a(o)]),s(" 可以查看最新版本：")]),y])}const E=i(k,[["render",x],["__file","docker-nginx-flv.html.vue"]]);export{E as default};
